# 小猪佩奇脚本转JSON测试用例转换器--src/evaluate/convert_peppa_script_to_test_cases.py

## 概述

该脚本将小猪佩奇对话脚本（`测试脚本.md`）转换为结构化的JSON测试用例，用于评估目的。转换过程创建"上下文-佩奇回应"测试对，其中每个测试用例代表触发佩奇特定回应的场景。

## 转换过程

### 1. 场景解析
- 根据`##`标题将脚本划分为不同场景
- 每个场景包含角色间的一系列对话
- 解析对话以识别说话者及其内容

### 2. 佩奇回应提取
- 识别脚本中佩奇的所有台词
- 为佩奇的每句台词，通过回溯确定触发上下文

### 3. 上下文确定
- 对于佩奇的每句回应，向后查找直接触发因素
- 通常是前一个其他角色的台词（非旁白）
- 有时包含提供重要上下文的旁白台词
- 最多可包含前3句台词以提供足够上下文

### 4. 测试用例构建
每个测试用例遵循以下结构：
```json
{
  "context": "触发佩奇回应的直接上下文",
  "expected_response": "佩奇的实际回应",
  "scene": "场景标题",
  "dialogue_index": "在原始对话序列中的位置"
}
```

## 输出结构

转换器生成具有以下结构的JSON文件：

```json
{
  "info": {
    "source": "源文件路径",
    "total_scenes": "处理的场景数量",
    "total_test_cases": "生成的测试用例总数",
    "conversion_timestamp": "转换执行时间"
  },
  "test_cases_by_scene": {
    "场景标题1": [
      {
        "context": "触发回应的上下文",
        "expected_response": "佩奇的回应",
        "scene": "场景标题1",
        "dialogue_index": 5
      }
      // 该场景的更多测试用例
    ],
    "场景标题2": [
      // 场景2的测试用例
    ]
    // 更多场景
  },
  "all_test_cases": [
    // 所有测试用例的平面列表
  ]
}
```

## 关键原则

1. **上下文准确性**：测试输入旨在重现导致佩奇回应的确切上下文
2. **触发识别**：上下文应包含直接触发因素（通常是前一个说话者的台词）
3. **最小上下文**：仅包含最相关的前置台词以保持上下文聚焦
4. **旁白包含**：当旁白提供关键上下文时将其包含在内

## 示例测试用例

```json
{
  "context": "旁白：哦，糟糕，车子听起来不对劲。",
  "expected_response": "出什么问题了，爸爸？",
  "scene": "23. 新车",
  "dialogue_index": 15
}
```

## 使用方法

运行转换：

```bash
python -m src.evaluate.convert_peppa_script_to_test_cases
```

脚本将：
1. 读取输入文件 `../result/testCase/测试脚本.md`
2. 处理所有场景并提取佩奇的回应
3. 为每个回应生成上下文触发对
4. 将结构化JSON输出到 `../result/testCase/structured_test_cases.json`

## 输出文件

- **输入**：`../result/testCase/测试脚本.md` - 原始小猪佩奇对话脚本
- **输出**：`../result/testCase/structured_test_cases.json` - 结构化JSON测试用例

## 统计信息

转换通常生成：
- 处理约11个场景
- 生成180+个独立测试用例
- 测试用例按场景分布，与对话长度成比例